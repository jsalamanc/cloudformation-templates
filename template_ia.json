{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "recursos para desplegar un agente bedrock con bases de conocimiento",
  "Parameters": {
    "LambdaCodeBucket": {
      "Type": "String",
      "Default": "tu-bucket-de-codigo",
      "Description": "Bucket S3 donde está el código Lambda"
    },
    "Environment": {
      "Type": "String",
      "Default": "dev",
      "AllowedValues": [
        "dev",
        "staging",
        "prod"
      ]
    },
    "AWSNovaLiteModel": {
      "Type": "String",
      "Default": "amazon.nova-lite-v1:0",
      "Description": "Model Nova Lite to use for the agent"
    },
    "AWSTitanTextEmbeddingModelArn": {
      "Type": "String",
      "Default": "arn:aws:bedrock:us-east-2::foundation-model/amazon.titan-embed-text-v2:0",
      "Description": "Embedding model to use for the agent"
    }
  },
  "Conditions": {
    "IsProd": {
      "Fn::Equals": [
        {
          "Ref": "Environment"
        },
        "prod"
      ]
    }
  },
  "Resources": {
    "AgentRole": {
      "Type": "AWS::IAM::Role",
      "Metadata": {
        "Purpose": "Rol IAM para acceso a bases de conocimiento"
      },
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": "bedrock.amazonaws.com"
              },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "Policies": [
          {
            "PolicyName": "BedrockKnowledgeBaseAccess",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "bedrock:Retrieve",
                    "bedrock:RetrieveAndGenerate",
                    "bedrock:InvokeModel",
                    "bedrock:CreateKnowledgeBase",
                    "bedrock:GetFoundationModel",
                    "bedrock:ListFoundationModels"
                  ],
                  "Resource": "*"
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "aoss:APIAccessAll",
                    "aoss:CreateIndex",
                    "aoss:DescribeIndex",
                    "aoss:ReadDocument",
                    "aoss:WriteDocument"
                  ],
                  "Resource": "*"
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "s3:GetObject",
                    "s3:ListBucket"
                  ],
                  "Resource": [
                    {
                      "Fn::GetAtt": [
                        "BucketDataDevOpsS3",
                        "Arn"
                      ]
                    },
                    {
                      "Fn::Sub": "${BucketDataDevOpsS3.Arn}/*"
                    }
                  ]
                }
              ]
            }
          }
        ]
      }
    },
    "NovaLiteParameter": {
      "Type": "AWS::SSM::Parameter",
      "Metadata": {
        "Purpose": "Parámetro que almacena el modelo Nova Lite"
      },
      "Properties": {
        "Name": "/agents/models/aws-nova-lite",
        "Type": "String",
        "Value": {
          "Ref": "AWSNovaLiteModel"
        },
        "Description": "Model to use for the agent"
      }
    },
    "BasicGuardrail": {
      "Type": "AWS::Bedrock::Guardrail",
      "Metadata": {
        "Purpose": "Filtro de contenido para el agente"
      },
      "Properties": {
        "Name": "BasicContentFilter",
        "BlockedInputMessaging": "Lo siento, no puedo procesar ese tipo de contenido. Por favor, reformula tu pregunta de manera apropiada.",
        "BlockedOutputsMessaging": "No puedo generar ese tipo de respuesta. Por favor, intenta con otra consulta.",
        "ContentPolicyConfig": {
          "FiltersConfig": [
            {
              "Type": "HATE",
              "InputStrength": "HIGH",
              "OutputStrength": "HIGH"
            },
            {
              "Type": "VIOLENCE",
              "InputStrength": "MEDIUM",
              "OutputStrength": "MEDIUM"
            }
          ]
        },
        "SensitiveInformationPolicyConfig": {
          "PiiEntitiesConfig": [
            {
              "Type": "EMAIL",
              "Action": "BLOCK"
            }
          ]
        }
      }
    },
    "OpenSearchEncryptionPolicy": {
      "Type": "AWS::OpenSearchServerless::SecurityPolicy",
      "Properties": {
        "Name": "encryption-policy-devops",
        "Type": "encryption",
        "Policy": "{\"Rules\":[{\"ResourceType\":\"collection\",\"Resource\":[\"collection/knowledge-collection-devops\"]}],\"AWSOwnedKey\":true}"
      }
    },
    "OpenSearchNetworkPolicy": {
      "Type": "AWS::OpenSearchServerless::SecurityPolicy",
      "Properties": {
        "Name": "network-policy-devops",
        "Type": "network",
        "Policy": "[{\"Rules\":[{\"ResourceType\":\"collection\",\"Resource\":[\"collection/knowledge-collection-devops\"]}],\"AllowFromPublic\":true}]"
      }
    },
    "OpenSearchCollection": {
      "Type": "AWS::OpenSearchServerless::Collection",
      "DependsOn": [
        "OpenSearchEncryptionPolicy",
        "OpenSearchNetworkPolicy"
      ],
      "Properties": {
        "Name": "knowledge-collection-devops",
        "Type": "VECTORSEARCH"
      }
    },
    "BucketDataDevOpsS3": {
      "Type": "AWS::S3::Bucket",
      "Metadata": {
        "Purpose": "Bucket para datos suplementarios de la base de conocimiento de devops"
      },
      "Properties": {
        "BucketName": {
          "Fn::Sub": "bedrock-devops-${Environment}-${AWS::AccountId}-${AWS::StackName}"
        },
        "VersioningConfiguration": {
          "Status": "Enabled"
        },
        "PublicAccessBlockConfiguration": {
          "BlockPublicAcls": true,
          "BlockPublicPolicy": true,
          "IgnorePublicAcls": true,
          "RestrictPublicBuckets": true
        }
      }
    },
    "CreateIndexLambdaRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": "lambda.amazonaws.com"
              },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "Policies": [
          {
            "PolicyName": "OpenSearchCreateIndexPolicy",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "aoss:*"
                  ],
                  "Resource": "*"
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "logs:CreateLogGroup",
                    "logs:CreateLogStream",
                    "logs:PutLogEvents"
                  ],
                  "Resource": "arn:aws:logs:*:*:*"
                }
              ]
            }
          }
        ]
      }
    },
    "LambdaDependenciesLayer": {
      "Type": "AWS::Lambda::LayerVersion",
      "Properties": {
        "LayerName": "OpenSearchPyDependencies",
        "Description": "Dependencies for OpenSearch Lambda function",
        "Content": {
          "S3Bucket": "layer-artifacts-lambdas",
          "S3Key": "my_dependencies_layer.zip"
        },
        "CompatibleRuntimes": [
          "python3.9"
        ]
      }
    },
    "CreateIndexLambda": {
      "Type": "AWS::Lambda::Function",
      "DependsOn": "LambdaDependenciesLayer",
      "Properties": {
        "Code": {
          "S3Bucket": "lambda-artifacts-functions",
          "S3Key": "function.zip"
        },
        "Handler": "create_index_handler.lambda_handler",
        "Role": {
          "Fn::GetAtt": [
            "CreateIndexLambdaRole",
            "Arn"
          ]
        },
        "Runtime": "python3.9",
        "Timeout": 300,
        "MemorySize": 128,
        "Layers": [
          {
            "Ref": "LambdaDependenciesLayer"
          }
        ]
      }
    },
    "LambdaOpenSearchAccessPolicy": {
      "Type": "AWS::OpenSearchServerless::AccessPolicy",
      "DependsOn": "CreateIndexLambda",
      "Properties": {
        "Name": "lambda-access-policy",
        "Type": "data",
        "Policy": {
          "Fn::Sub": [
            "[{\"Rules\":[{\"Resource\":[\"collection/knowledge-collection-devops\"],\"Permission\":[\"aoss:*\"],\"ResourceType\":\"collection\"},{\"Resource\":[\"index/knowledge-collection-devops/*\"],\"Permission\":[\"aoss:*\"],\"ResourceType\":\"index\"}],\"Principal\":[\"${LambdaRoleArn}\"]}]",
            {
              "LambdaRoleArn": {
                "Fn::GetAtt": [
                  "CreateIndexLambdaRole",
                  "Arn"
                ]
              }
            }
          ]
        }
      }
    },
    "AgentOpenSearchAccessPolicy": {
      "Type": "AWS::OpenSearchServerless::AccessPolicy",
      "DependsOn": [
        "AgentRole",
        "OpenSearchCollection"
      ],
      "Properties": {
        "Name": "agent-access-policy",
        "Type": "data",
        "Policy": {
          "Fn::Sub": [
            "[{\"Rules\":[{\"Resource\":[\"collection/knowledge-collection-devops\"],\"Permission\":[\"aoss:*\"],\"ResourceType\":\"collection\"},{\"Resource\":[\"index/knowledge-collection-devops/*\"],\"Permission\":[\"aoss:*\"],\"ResourceType\":\"index\"}],\"Principal\":[\"${AgentRoleArn}\"]}]",
            {
              "AgentRoleArn": {
                "Fn::GetAtt": [
                  "AgentRole",
                  "Arn"
                ]
              }
            }
          ]
        }
      }
    },
    "OpenSearchVectorIndex": {
      "Type": "Custom::OpenSearchVectorIndex",
      "DependsOn": [
        "OpenSearchCollection",
        "CreateIndexLambda",
        "LambdaOpenSearchAccessPolicy",
        "AgentOpenSearchAccessPolicy"
      ],
      "Properties": {
        "ServiceToken": {
          "Fn::GetAtt": [
            "CreateIndexLambda",
            "Arn"
          ]
        },
        "CollectionEndpoint": {
          "Fn::GetAtt": [
            "OpenSearchCollection",
            "CollectionEndpoint"
          ]
        },
        "VectorIndexName": "bedrock-knowledge-base-index"
      }
    },
    "KnowledgeBaseDevOps": {
      "Type": "AWS::Bedrock::KnowledgeBase",
      "DependsOn": [
        "OpenSearchCollection",
        "AgentRole",
        "BucketDataDevOpsS3",
        "OpenSearchVectorIndex",
        "AgentOpenSearchAccessPolicy"
      ],
      "Properties": {
        "Name": "KnowledgeBaseDevOps",
        "Description": "Knowledge base for the agent DevOps",
        "RoleArn": {
          "Fn::GetAtt": [
            "AgentRole",
            "Arn"
          ]
        },
        "KnowledgeBaseConfiguration": {
          "Type": "VECTOR",
          "VectorKnowledgeBaseConfiguration": {
            "EmbeddingModelArn": {
              "Ref": "AWSTitanTextEmbeddingModelArn"
            },
            "EmbeddingModelConfiguration": {
              "BedrockEmbeddingModelConfiguration": {
                "Dimensions": 1024,
                "EmbeddingDataType": "FLOAT32"
              }
            },
            "SupplementalDataStorageConfiguration": {
              "SupplementalDataStorageLocations": [
                {
                  "S3Location": {
                    "URI": {
                      "Fn::Sub": "s3://${BucketDataDevOpsS3}"
                    }
                  },
                  "SupplementalDataStorageLocationType": "S3"
                }
              ]
            }
          }
        },
        "StorageConfiguration": {
          "Type": "OPENSEARCH_SERVERLESS",
          "OpensearchServerlessConfiguration": {
            "CollectionArn": {
              "Fn::GetAtt": [
                "OpenSearchCollection",
                "Arn"
              ]
            },
            "VectorIndexName": "bedrock-knowledge-base-index",
            "FieldMapping": {
              "VectorField": "bedrock-knowledge-base-default-vector-devops",
              "TextField": "AMAZON_BEDROCK_TEXT_CHUNK",
              "MetadataField": "AMAZON_BEDROCK_METADATA"
            }
          }
        },
        "Tags": {
          "Project": "Chatbot",
          "Environment": {
            "Ref": "Environment"
          },
          "Version": "v1"
        }
      }
    },
    "AgentDevOps": {
      "Type": "AWS::Bedrock::Agent",
      "Metadata": {
        "Purpose": "Agente principal con memoria y configuración de tags"
      },
      "Properties": {
        "AgentName": "AgentDevOps",
        "FoundationModel": {
          "Ref": "AWSNovaLiteModel"
        },
        "AutoPrepare": true,
        "Instruction": "te llamaras Antonio, eres un experto expecializado en aws, si el usuario te llega a realizar preguntas relacionadas con aws, aprovecha la base de conocimientos pra nutrirte de informacion directa de aws, siempre las respuestas debes enviarselas al usuario en español, y los ejemplos de codigo envalos en formato markdown",
        "Description": "Agent for developer",
        "MemoryConfiguration": {
          "EnabledMemoryTypes": [
            "SESSION_SUMMARY"
          ],
          "StorageDays": 30
        },
        "KnowledgeBases": [
          {
            "Description": "Knowledge base for the agent DevOps",
            "KnowledgeBaseId": {
              "Ref": "KnowledgeBaseDevOps"
            },
            "KnowledgeBaseState": "ACTIVE"
          }
        ],
        "AgentResourceRoleArn": {
          "Fn::GetAtt": [
            "AgentRole",
            "Arn"
          ]
        },
        "GuardrailConfiguration": {
          "GuardrailIdentifier": {
            "Ref": "BasicGuardrail"
          },
          "GuardrailVersion": {
            "Fn::If": [
              "IsProd",
              "1",
              "DRAFT"
            ]
          }
        },
        "Tags": {
          "Project": "Chatbot",
          "Environment": {
            "Ref": "Environment"
          },
          "Version": "v1"
        },
        "TestAliasTags": {
          "Environment": {
            "Ref": "Environment"
          },
          "Stage": {
            "Fn::If": [
              "IsProd",
              "production",
              "development"
            ]
          }
        }
      }
    },
    "AgentDevOpsErrorAlarm": {
      "Type": "AWS::CloudWatch::Alarm",
      "Metadata": {
        "Purpose": "Monitorea errores del agente en todos los entornos"
      },
      "Properties": {
        "AlarmName": {
          "Fn::Sub": "${AgentDevOps}-Errors-${Environment}"
        },
        "AlarmDescription": "Agent error rate is too high",
        "MetricName": "InvocationClientErrors",
        "Namespace": "AWS/Bedrock",
        "Statistic": "Sum",
        "Period": 300,
        "EvaluationPeriods": 2,
        "Threshold": 5,
        "ComparisonOperator": "GreaterThanThreshold",
        "Dimensions": [
          {
            "Name": "AgentId",
            "Value": {
              "Ref": "AgentDevOps"
            }
          }
        ]
      }
    },
    "AgentDevOpsLatencyAlarm": {
      "Type": "AWS::CloudWatch::Alarm",
      "Condition": "IsProd",
      "Metadata": {
        "Purpose": "Monitorea latencia alta solo en producción"
      },
      "Properties": {
        "AlarmName": {
          "Fn::Sub": "${AgentDevOps}-HighLatency-${Environment}"
        },
        "AlarmDescription": "Agent response time is too high",
        "MetricName": "InvocationLatency",
        "Namespace": "AWS/Bedrock",
        "Statistic": "Average",
        "Period": 300,
        "EvaluationPeriods": 3,
        "Threshold": 10000,
        "ComparisonOperator": "GreaterThanThreshold",
        "Dimensions": [
          {
            "Name": "AgentId",
            "Value": {
              "Ref": "AgentDevOps"
            }
          }
        ]
      }
    }
  }
}